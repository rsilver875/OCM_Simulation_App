<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Setup</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f7f7f8;
      color: #111;
    }
    h1 {
      font-size: 1.1rem;
      margin: 0 0 1rem;
      text-align: center;
    }
    #login {
      max-width: 520px;
      margin: 1.5rem auto;
      padding: 1rem;
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      background: #fff;
    }
    label {
      display: block;
      margin-bottom: .75rem;
    }
    input[type=password] {
      width: 100%;
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      margin-top: .5rem;
      padding: .45rem .75rem;
      border-radius: 4px;
      border: 1px solid #bbb;
      background: #f3f3f3;
      cursor: pointer;
    }
    #frameContainer {
      max-width: 100%;
      margin: 1rem auto;
    }
    iframe {
      width: 100%;
      height: 70vh;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .hidden {
      display: none;
    }
    p.note {
      color: #666;
      font-size: 0.9rem;
      margin-top: .75rem;
    }
    #controls {
      max-width: 520px;
      margin: 0.5rem auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Admin — Setup</h1>
  <div id="login">
    <label for="pw">
      Password:
      <input id="pw" type="password" autocomplete="current-password" placeholder="Enter admin password">
    </label>
    <div>
      <button id="go">Enter</button>
      <button id="clear" style="display:none">Logout</button>
    </div>
    <p class="note">
      This admin page is intentionally not linked from the site. It uses client-side password gating only — NOT secure.
      Replace the PASSWORD constant in this file before use.
    </p>
  </div>

  <div id="frameContainer" class="hidden">
    <div id="controls" class="hidden">
      <button id="connectBtn">Connect with GitHub</button>
      <button id="saveBtn" disabled>Save to GitHub</button>
      <span id="status" style="margin-left:.5rem;color:#666"></span>
    </div>
    <iframe id="setupFrame" src="" title="Setup"></iframe>
  </div>

  <script>
    /*
      OAuth flow (popup + code exchange):
      - Register an OAuth App with redirect_uri pointing to /admin/oauth_callback.html
      - Edit CLIENT_ID and REDIRECT_URI below to match your OAuth App / host
      - Backend endpoints:
        POST /auth/exchange { code } -> exchanges code, stores token in server session
        GET /auth/status -> returns { authenticated: true/false, user: {login} }
        POST /save-config -> server-side commit using token in session

      - The Setup iframe should provide a way to supply the JSON config to its parent, for example:
        window.parent.postMessage({ type: 'CONFIG_JSON', json: yourConfigObject }, '*')
        Or respond to a request message from parent: { type: 'REQUEST_CONFIG' }
        and then post the CONFIG_JSON back.
    */
    const PASSWORD = "ADMIN"; // replace before use
    const CLIENT_ID = 'Ov23liI5TRht7jSvtU4N'; // Edit as needed
    const REDIRECT_URI = location.origin + '/admin/oauth_callback.html';
    const AUTHORIZE_URL_BASE = 'https://github.com/login/oauth/authorize';
    const SCOPES = 'public_repo'; // use 'repo' for private repo access

    const pwInput = document.getElementById('pw');
    const goBtn = document.getElementById('go');
    const clearBtn = document.getElementById('clear');
    const loginDiv = document.getElementById('login');
    const frameContainer = document.getElementById('frameContainer');
    const setupFrame = document.getElementById('setupFrame');
    const connectBtn = document.getElementById('connectBtn');
    const saveBtn = document.getElementById('saveBtn');
    const controlsDiv = document.getElementById('controls');
    const statusSpan = document.getElementById('status');
    let oauthWindow = null;
    let latestConfigJson = null;

    function showFrame() {
      loginDiv.classList.add('hidden');
      frameContainer.classList.remove('hidden');
      clearBtn.style.display = 'inline-block';
      controlsDiv.classList.remove('hidden');
      setupFrame.src = '../Setup.html';
      checkAuthStatus();
    }

    goBtn.addEventListener('click', () => {
      if (pwInput.value === PASSWORD) {
        showFrame();
      } else {
        alert('Incorrect password');
        pwInput.value = '';
        pwInput.focus();
      }
    });

    pwInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') goBtn.click();
    });

    clearBtn.addEventListener('click', () => {
      setupFrame.src = '';
      frameContainer.classList.add('hidden');
      loginDiv.classList.remove('hidden');
      pwInput.value = '';
      clearBtn.style.display = 'none';
      controlsDiv.classList.add('hidden');
      statusSpan.textContent = '';
    });

    // --- OAuth popup flow ---
    connectBtn.addEventListener('click', () => {
      const state = Math.random().toString(36).slice(2); // minimal CSRF token
      sessionStorage.setItem('gh_oauth_state', state);
      const url = `${AUTHORIZE_URL_BASE}?client_id=${encode

